@page "{patientId:int}"
@model MyAPI.Web.Pages.Seizures.RegisterModel
@using MyAPI.Core.Entities
@{
    ViewData["Title"] = "Registrer Anfald";
}

<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1>⚡ Registrer Anfald</h1>
            <p class="lead">Patient: <strong>@Model.PatientName</strong></p>
        </div>
    </div>

    @* INGEN AKTIVT ANFALD - VIS START KNAP *@
    @if (Model.ActiveSeizure == null && !Model.ShowSaveForm)
    {
        <div class="row">
            <div class="col-md-8 mx-auto text-center">
                <div class="alert alert-warning mb-4">
                    <strong>Hurtig registrering:</strong> Klik på knappen nedenfor straks når anfaldet starter.
                    Du kan udfylde alle detaljer når du stopper anfaldet.
                </div>

                <form method="post" asp-page-handler="QuickStart">
                    <input type="hidden" name="patientId" value="@Model.PatientId" />
                    <button type="submit" class="btn btn-danger btn-lg w-100 py-5 shadow-lg"
                            style="font-size: 2.5rem; border-radius: 15px;">
                        🚨 START ANFALD NU<br>
                        <small style="font-size: 1.2rem;">Klik straks - hvert sekund tæller!</small>
                    </button>
                </form>
            </div>
        </div>
    }

    @* AKTIVT ANFALD - VIS STOP KNAP *@
    @if (Model.ActiveSeizure != null && !Model.ShowSaveForm)
    {
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card border-warning shadow-lg">
                    <div class="card-header bg-warning text-dark">
                        <h3 class="mb-0">⏱️ ANFALD I GANG</h3>
                    </div>
                    <div class="card-body text-center">
                        <div class="display-1 text-danger fw-bold mb-3" id="timer">00:00</div>
                        <p class="text-muted">Startet: @Model.ActiveSeizure.StartTime.ToString("HH:mm:ss")</p>

                        <form method="post" asp-page-handler="Stop" class="mt-4">
                            <input type="hidden" name="seizureId" value="@Model.ActiveSeizure.Id" />
                            <button type="submit" class="btn btn-success btn-lg w-100 py-3" style="font-size: 1.5rem;">
                                ⏹️ STOP ANFALD<br>
                                <small style="font-size: 1rem;">Klik for at stoppe og udfylde detaljer</small>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const startTime = new Date('@Model.ActiveSeizure.StartTime.ToString("yyyy-MM-ddTHH:mm:ss")');
            function updateTimer() {
                const now = new Date();
                const diff = now - startTime;
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                document.getElementById('timer').textContent =
                    String(minutes).padStart(2, '0') + ':' +
                    String(seconds).padStart(2, '0');
            }
            setInterval(updateTimer, 1000);
            updateTimer();
        </script>
    }

    @* GEM FORMULAR - Efter stop *@
    @if (Model.ShowSaveForm && Model.ActiveSeizure != null)
    {
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card border-primary shadow-lg">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">📝 Udfyld Anfaldsdetaljer</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-4">
                            <strong>Anfald stoppet:</strong> @Model.ActiveSeizure.EndTime?.ToString("HH:mm:ss")<br>
                            <strong>Varighed:</strong> <span id="duration">@(Model.ActiveSeizure.Duration?.ToString(@"mm\:ss") ?? "00:00")</span>
                        </div>

                        <form method="post" asp-page-handler="Save">
                            <input type="hidden" name="seizureId" value="@Model.ActiveSeizure.Id" />

                            @* Anfaldstype *@
                            <div class="mb-3">
                                <label class="form-label fw-bold">Anfaldstype <span class="text-danger">*</span></label>
                                <select name="seizureType" class="form-select form-select-lg" required>
                                    <option value="">-- Vælg type --</option>
                                    @foreach (SeizureType type in Enum.GetValues(typeof(SeizureType)))
                                    {
                                        <option value="@type">@type</option>
                                    }
                                </select>
                            </div>

                            @* Symptomer *@
                            <div class="mb-3">
                                <label class="form-label fw-bold">Symptomer</label>
                                <select name="symptomIds" class="form-select" multiple size="4">
                                    @foreach (var symptom in Model.Symptoms)
                                    {
                                        <option value="@symptom.Id">@symptom.Name</option>
                                    }
                                </select>
                                <div class="form-text">Hold Ctrl for at vælge flere</div>
                            </div>

                            @* Bevidsthedstab *@
                            <div class="mb-3 form-check">
                                <input type="checkbox" name="consciousnessLoss" class="form-check-input" id="consciousnessCheck" value="true" />
                                <label class="form-check-label fw-bold" for="consciousnessCheck">
                                    Patienten mistede bevidstheden
                                </label>
                            </div>

                            @* Noter *@
                            <div class="mb-4">
                                <label class="form-label fw-bold">Noter</label>
                                <textarea name="notes" class="form-control" rows="3"
                                      placeholder="Beskriv hvad der skete..."></textarea>
                            </div>

                            @* Knapper *@
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg">
                                    💾 GEM ANFALD
                                </button>
                                <button type="submit" asp-page-handler="Cancel" name="seizureId" value="@Model.ActiveSeizure.Id"
                                        class="btn btn-outline-secondary" onclick="return confirm('Fortsæt anfaldet? Tidtagningen genoptages.')">
                                    ↩️ ANNULLER - Fortsæt anfald
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="mt-4">
        <a asp-page="/Patients/Details" asp-route-id="@Model.PatientId" class="btn btn-secondary">
            ← Tilbage til patient
        </a>
    </div>
</div>